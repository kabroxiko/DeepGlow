---
name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [ main, master ]

jobs:
  deps:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-deps.outputs.cache-key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create Python venv
        run: |
          python -m venv .venv

      - name: Activate venv and install PlatformIO
        run: |
          source .venv/bin/activate
          pip install --upgrade pip
          pip install platformio intelhex

      - name: Update PlatformIO libraries
        run: |
          source .venv/bin/activate
          pio pkg update

      - name: Install PlatformIO libraries (explicit)
        run: |
          source .venv/bin/activate
          pio pkg install

      - name: Cache Python venv and PlatformIO dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.platformio/.cache
            ~/.platformio/lib
          key: pio-venv-deps-${{ hashFiles('platformio.ini', 'VERSION') }}

  build:
    needs: deps
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [esp32, esp32d, esp8266, athom]
    outputs:
      envs: ${{ toJson(matrix.env) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore PlatformIO dependencies
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.platformio/.cache
            ~/.platformio/lib
          key: pio-venv-deps-${{ hashFiles('platformio.ini', 'VERSION') }}
      - name: Clean build output directory
        run: |
          rm -rf .pio/build/${{ matrix.env }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Activate venv and ensure PlatformIO
        run: |
          source .venv/bin/activate
          pip install --upgrade pip

      - name: Build firmware for ${{ matrix.env }} (with retry)
        run: |
          source .venv/bin/activate
          n=0
          until [ "$n" -ge 3 ]
          do
            platformio run -e ${{ matrix.env }} && break
            n=$((n+1))
            echo "Build failed, retrying ($n/3)..."
            sleep 10
          done
          if [ "$n" -ge 3 ]; then
            echo "Build failed after 3 attempts." >&2
            exit 1
          fi

      - name: Compress firmware binaries
        run: |
          find .pio/build/${{ matrix.env }} -type f -name '*.bin' -exec gzip -k -n {} \;

      - name: Rename .bin.gz files with env and version
        run: |
          VERSION=$(cat VERSION)
          # Ensure version always has 'v' prefix
          if [[ $VERSION != v* ]]; then
            VERSION="v$VERSION"
          fi
          for f in .pio/build/${{ matrix.env }}/*.bin.gz; do \
            BASE=$(basename "$f" .bin.gz); \
            mv "$f" ".pio/build/${{ matrix.env }}/${BASE}_${{ matrix.env }}_${VERSION}.bin.gz"; \
          done

      - name: Record built environment
        run: echo "${{ matrix.env }}" > built_envs_${{ matrix.env }}.txt

      - name: Upload build artifacts and env file for ${{ matrix.env }}
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.env }}
          path: |
            .pio/build/${{ matrix.env }}/*.bin.gz
            built_envs_${{ matrix.env }}.txt

  manifest:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all build artifacts and env files
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: .

      - name: Move all .bin.gz files to a single directory
        run: |
          mkdir -p firmware_bin_gz
          find . -name '*.bin.gz' -exec mv {} firmware_bin_gz/ \;

      - name: List built_envs files
        run: find . -name 'built_envs_*.txt' -exec ls -l {} \; || echo 'No built_envs_*.txt found'

      - name: Collect all unique envs
        id: collect_envs
        run: |
          find . -name 'built_envs_*.txt' -exec cat {} \; | sort | uniq | tr '\n' ' ' > all_envs.txt
          echo "ENVS=$(cat all_envs.txt)" >> $GITHUB_ENV

      - name: Set manifest environment variables
        run: |
          echo "FIRMWARE_TYPE=DeepGlow" >> $GITHUB_ENV
          echo "FIRMWARE_BASE_URL=https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/" >> $GITHUB_ENV

      - name: Generate manifest.json for OTA
        run: |
          VERSION=$(cat VERSION)
          # Ensure version always has 'v' prefix
          if [[ $VERSION != v* ]]; then
            VERSION="v$VERSION"
          fi
          FIRMWARE_TYPE="${FIRMWARE_TYPE:-DeepGlow}"
          BASE_URL="${FIRMWARE_BASE_URL:-https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/}"
          tmpfile=$(mktemp)
          echo '[' > "$tmpfile"
          first=1
          for ENV in $ENVS; do
            FILENAME="firmware_${ENV}_${VERSION}.bin.gz"
            [ $first -eq 0 ] && echo ',' >> "$tmpfile"
            echo "  {\"type\": \"${FIRMWARE_TYPE}\", \"env\": \"${ENV}\", \"version\": \"${VERSION}\", \"url\": \"${BASE_URL}${FILENAME}\"}" >> "$tmpfile"
            first=0
          done
          echo ']' >> "$tmpfile"
          cat "$tmpfile" | jq '.' > manifest.json
          rm "$tmpfile"
        env:
          FIRMWARE_TYPE: ${{ env.FIRMWARE_TYPE }}
          FIRMWARE_BASE_URL: ${{ env.FIRMWARE_BASE_URL }}
          ENVS: ${{ env.ENVS }}

      - name: Upload manifest.json
        uses: actions/upload-artifact@v4
        with:
          name: manifest-json
          path: manifest.json

  release:
    needs: [build, manifest]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware

      - name: Download manifest.json
        uses: actions/download-artifact@v4
        with:
          name: manifest-json
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            firmware/*/*.bin.gz
            manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
